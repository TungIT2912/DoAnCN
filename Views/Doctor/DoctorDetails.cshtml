<!DOCTYPE html>
<html lang="en">
@{
    Layout = "~/Views/Shared/_LayoutCustomer.cshtml";
}
<head>
    <meta charset="utf-8">
    @* <title>Medicoz | Doctor Detail</title> *@

    <!-- Stylesheets -->
    <link href="~/css/bootstrap.css" rel="stylesheet">
    <link href="~/css/style.css" rel="stylesheet">
    <link href="~/css/responsive.css" rel="stylesheet">
    <link id="theme-color-file" href="~/css/color-themes/scarlet.css" rel="stylesheet">
    <link rel="shortcut icon" href="~/images/favicon.png" type="image/x-icon">
    <link rel="icon" href="~/images/favicon.png" type="image/x-icon">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>

<body>
    <div class="page-wrapper">
        <!--Page Title-->
<section class="page-title" style="background-image: url('@Url.Content("~/images/background/8.jpg")');">
            <div class="auto-container">
                <div class="title-outer">
                    <h1>Chi tiết bác sĩ</h1>
                    <ul class="page-breadcrumb">
                        <li><a href="~/Home/Index">Trang chủ</a></li>
                        <li>Bác sĩ</li>
                    </ul> 
                </div>
            </div>
        </section>

        <!-- Doctor Detail Section -->
        <section class="doctor-detail-section">
            <div class="auto-container">
                <div class="row">
                    <!-- Content Side -->
                    <div class="content-side col-lg-8 col-md-12 col-sm-12 order-2">
                        <div class="doctor-detail">
                            <!-- Doctor's Name -->
                            <h3 class="name">@Model.Ten</h3>
                            <!-- Doctor's Designation -->
                            <span class="designation">@Model.TenCv</span>
                            <hr>
                            <!-- Doctor's Biography -->
                            <div class="text">@(@Model.Mota ?? "Không có chi tiết mô tả")</div>

                            <hr>
                            <ul class="doctor-info-list">
                                @* <li>
                                    <strong>Speciality</strong>
                                    <p>@Model.ChucVu?.Ten</p>
                                </li> *@
                                @* <li>
                                    <strong>Education</strong>
                                    <p>Medical degree and training details can be added here if available.</p>
                                </li> *@
                                <li>
                                    <strong>Kinh nghiệm</strong>
                                    <p>@Model.KinhNghiem </p>
                                </li>
                                <li>
                                    <strong>Địa chỉ</strong>
                                    <p>@Model.Diachi</p>
                                </li>
                                <li>
                                    <strong>Thời gian</strong>
                                <li class="zf-radio zf-tempFrmWrapper">
                                    <div class="zf-tempContDiv">
                                            @if (@Model.sa.Any())
                                            {
                                            <div class="table-responsive">
                                                <table class="table table-bordered table-striped">
                                                    <thead class="thead-dark">
                                                        <tr>
                                                            <th>Thứ</th>
                                                            <th>Thời gian làm việc</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                            @foreach (var shift in Model.Shifts)
                                                            {
                                                            <tr>
                                                                <td>
                                                                        @switch (shift.DayOfWeek)
                                                                        {
                                                                            case "Thứ hai":
                                                                                @:Thứ 2
                                                                                break;
                                                                            case "Thứ ba":
                                                                                @:Thứ 3
                                                                                break;
                                                                            case "Thứ tư":
                                                                                @:Thứ 4
                                                                                break;
                                                                            case "Thứ năm":
                                                                                @:Thứ 5
                                                                                break;
                                                                            case "Thứ sáu":
                                                                                @:Thứ 6
                                                                                break;
                                                                        }
                                                                </td>
                                                                <td>@shift.StartTime.ToString(@"hh\:mm tt") - @shift.EndTime.ToString(@"hh\:mm tt")</td>
                                                            </tr>
                                                            }
                                                    </tbody>
                                                </table>
                                            </div>
                                            }
                                            else
                                            {
                                            <p class="text-muted">Không có thông tin về ca làm việc của nhân viên này.</p>
                                            }
                                    </div>
                                </li>
                                </li>
                                <li>
                                    <strong>SĐT</strong>
                                    <p><a href="tel:@Model.Sdt">@Model.Sdt</a></p>
                                </li>
                                <li>
                                    <strong>Email</strong>
                                    <p><a href="mailto:@Model.Email">@Model.Email</a></p>
                                </li>
                            </ul>
                        </div>

                        <!-- Appointment Form -->
                        <div class="appointment-form default-form">
                            <div class="sec-title">
                                <span class="sub-title">Lịch khám online</span>
                                <h2>Đặt lịch khám</h2>
                                <span class="divider"></span>
                            </div>

                            <!-- Appointment Form -->
                                  <!-- The form where you're targeting the button -->
                            <form id="createBenhNhan" method="post" action="/BookAppointment/api/PostBenhNhan">
                            <div class="row">
                                <div class="form-group col-lg-6 col-md-12">
                                    <input type="text" name="username" placeholder="Họ và tên">
                                </div>
                                <div class="form-group col-lg-6 col-md-12">
                                    <div>
                                        <input  type="radio" name="gender" value="True" />
                                        <span>Nữ</span>
                                    </div>
                                    <div>
                                        <input  type="radio" name="gender" value="False" />
                                        <span>Nam</span>
                                    </div>
                                </div>
                                <div class="form-group col-lg-6 col-md-12">
                                    <input type="text" name="NamSinh" placeholder="Nhập năm sinh">
                                </div>
                                <div class="form-group col-lg-6 col-md-12">
                                    <input type="text" name="Sdt" placeholder="SĐT">
                                    </div>
                                <div class="form-group col-lg-12 col-md-12">
                                    <input type="email" name="EmailBn" placeholder="Email">
                                </div>
                                <div class="form-group col-lg-12 col-md-12">
                                    <input type="text" name="DiaChi" placeholder="Nhập địa chỉ của bạn">
                                </div>
                                <div class="form-group col-lg-12 col-md-12">
                                        <label  class="control-label">Ngày khám đầu</label>
                                        <input name="NgayKhamDau" type="date" id="bookingDate"
                                               class="form-control border-0 datetimepicker-input"
                                               placeholder="Choose Date"
                                               data-target="#date" data-toggle="datetimepicker"
                                               style="height: 55px;"
                                               value="@ViewBag.SelectedDate">
                                        <span  class="text-danger"></span>
                                </div>
                                <div class="form-group col-lg-12 col-md-12">
                                        <label class="control-label">Ca khám</label>
                                        <select id="bookingTime" name="time" required>
                                            <option value="">Chọn ca khám</option>
                                           
                                        </select>
                                        <span  class="text-danger"></span>
                                </div>
                                <div class="form-group col-lg-12 col-md-12">
                                    <textarea name="contact_message" placeholder="Triệu chứng"></textarea>
                                </div>

                                <div class="form-group col-lg-12 col-md-12">
                                    <button class="theme-btn btn-style-one" type="submit" name="submit-form"><span class="btn-title">Gửi yêu cầu</span></button>
                                </div>
                            </div>
                        </form>

                        </div>
                    </div>
                    <!-- Sidebar Side -->
                    <div class="sidebar-side col-lg-4 col-md-12 col-sm-12">
                        <div class="sidebar"> 
                            <!-- Team Block (optional image) -->
                            <div class="team-block wow fadeInUp">
                                <div class="inner-box">
                                    <figure class="image">
                                        <img src="@Url.Content(Model.Hinh)" alt="@Model.Ten">
                                    </figure>
                                    <ul class="social-links">
                                        <li><a href="#"><span class="fab fa-facebook"></span></a></li>
                                        <li><a href="#"><span class="fab fa-google-plus-g"></span></a></li>
                                        <li><a href="#"><span class="fab fa-twitter"></span></a></li>
                                        <li><a href="#"><span class="fab fa-pinterest"></span></a></li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Doctor Availability -->
                            <div class="doctor-availability">
                                <div class="inner">
                                    <div class="sec-title">
                                        @* <span class="sub-title"></span> *@
                                        <h2>Thời gian biểu</h2>
                                        <span class="divider"></span>
                                        <div class="text">Bác sĩ có mặt trong các giờ sau:</div>
                                        <ul class="timing-list-two">
                                            <li>T2 - T6 <span>08:00 - 17:00</span></li>
                                        </ul>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Team Section (optional, showing other doctors) -->
        <section class="team-section">
            <!-- Additional team section code if necessary -->
        </section>

        <!-- Clients Section -->
        <section class="clients-section alternate">
            <div class="auto-container">
                <div class="sponsors-outer">
                    <!-- Clients Carousel -->
                    <ul class="clients-carousel owl-carousel owl-theme">
                        <li class="slide-item"> <a href="#"><img src="~/images/clients/1.png" alt=""></a> </li>
                        <li class="slide-item"> <a href="#"><img src="~/images/clients/2.png" alt=""></a> </li>
                        <li class="slide-item"> <a href="#"><img src="~/images/clients/3.png" alt=""></a> </li>
                        <li class="slide-item"> <a href="#"><img src="~/images/clients/4.png" alt=""></a> </li>
                        <li class="slide-item"> <a href="#"><img src="~/images/clients/5.png" alt=""></a> </li>
                    </ul>
                </div>
            </div>
        </section>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>

        $(document).ready(function () {
            console.log("Document ready!");

          
            var doctorId = '@(Model.MaNv ?? "")'; 
            console.log("pick doctor: ", doctorId);
            $('#bookingDate').change(function () {
                var selectedDate = $(this).val();
                console.log("Selected Date: ", selectedDate);
                console.log(" doctor: ", doctorId);
                if (selectedDate && doctorId) {
                    fetchAvailableSlots(doctorId, selectedDate);
                }
            });

            function fetchAvailableSlots(doctorId, selectedDate) {
                console.log("Fetching available slots for doctor " + doctorId + " and date " + selectedDate);

                fetch(`/BookAppointment/getAvailableSlots?ngayKham=${selectedDate}&maNv=${doctorId}`)
                    .then(response => {
                        if (!response.ok) {
                            // return response.text().then(errorMessage => {
                            //     throw new Error(errorMessage);
                            // });
                            alert("Dịch vụ chúng tôi không hoạt động vào thứ 7 và chủ nhật.");
                        }
                        return response.json();
                    })
                    .then(result => {
                        console.log("Available slots: ", result);

                        const timeSelect = $('#bookingTime');
                        timeSelect.empty();
                        timeSelect.append('<option value="">Chọn ca khám</option>');

                        let disabledTimes = result.disabledSlots;

                       

                        result.availableSlots.forEach(slot => {
                            timeSelect.append(`<option value="${slot}">${slot}</option>`);

                        });


                        result.disabledSlots.forEach(slot => {
                            timeSelect.append(`<option value="${slot}" disabled>${slot} - Ca này đã kín</option>`);
                        });


                      

                    })
                    .catch(error => {
                        console.error("Error fetching available slots:", error);
                        
                    });
            }
            $('#createBenhNhan').submit(function (event) {
                    event.preventDefault();
                console.log("Form submission triggered");

                const selectedTime = $('[name="time"]').val();
                const selectedDay = $('[name="NgayKhamDau"]').val();

                if (!selectedTime || !selectedDay) {
                    alert("Xin hãy chọn ngày và ca khám.");
                    return;
                }

                console.log("Selected Time: ", selectedTime);
                console.log("Selected Day: ", selectedDay);

                const benhNhanData = {
                    HoTen: $('[name="username"]').val(),
                    Gioi: $('[name="gender"]:checked').val() === "True",
                    NamSinh: $('[name="NamSinh"]').val(),
                    Sdt: $('[name="Sdt"]').val(),
                    DiaChi: $('[name="DiaChi"]').val(),
                    EmailBn: $('[name="EmailBn"]').val(),
                    IddichVu: '@Model.IddichVu',
                    MaNv: doctorId,
                    TrieuChung: $('[name="TrieuChung"]').val(),
                    NgayKhamDau: selectedDay,
                    Time: convertToDateTime(selectedTime, selectedDay)
                };

                console.log("Data being sent:", benhNhanData);

                fetch('/BookAppointment/api/PostBenhNhan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(benhNhanData)
                })
                    .then(response => {
                        if (response.ok) {
                            alert("Đăng ký khám thành công!");
                            window.location.href = "/";
                        } else {
                            alert("Đăng ký khám thất bại.");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("Lỗi khi đăng ký khám.");
                    });
            });

            function convertToDateTime(timeString, selectedDay) {
                const [time, ampm] = timeString.split(" ");
                const [hours, minutes] = time.split(":").map(Number);

                let adjustedHours = hours;
                if (ampm === "PM" && adjustedHours < 12) {
                    adjustedHours += 12;
                } else if (ampm === "AM" && adjustedHours === 12) {
                    adjustedHours = 0;
                }

                const [year, month, day] = selectedDay.split('-');

                const dateTimeString = `${year}-${month}-${day}T${adjustedHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:00.000`;

                console.log("Generated DateTime string:", dateTimeString);

                return dateTimeString;
            }
        });

    </script>
</body>
</html>
