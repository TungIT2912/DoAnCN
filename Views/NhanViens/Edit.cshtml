@model WebQuanLyNhaKhoa.DTO.NhanVienDTO

@{
    ViewData["Title"] = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<head>
    <meta charset="UTF-8">
    <link href="~/css/form.css" rel="stylesheet" type="text/css">
</head>

<script>
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<div class="mobile-menu-overlay"></div>

<div class="main-container">
    <div class="xs-pd-20-10 pd-ltr-20">
        <div class="row clearfix progress-box">
            <div class="col-lg-12">
                <a asp-action="Index">
                    <button class="rounded-lg px-4 py-2 border-2 border-black-500 text-black-500 hover:bg-blue-600 hover:text-blue-100 duration-300">
                        ← Quay về lại danh sách
                    </button>
                </a>
                <br>
                <hr>

                <body class="zf-backgroundBg">
                    <div class="zf-templateWidth">
                        <form action="/YourAction" name="form" method="POST" enctype="multipart/form-data" id="createNhanVienForm">
                            <div class="zf-templateWrapper">
                                <!-- Header -->
                                <ul class="zf-tempHeadBdr">
                                    <li class="zf-tempHeadContBdr">
                                        <h2 class="zf-frmTitle"><em>Cập nhật nhân viên mới</em></h2>
                                        <p class="zf-frmDesc">Điều chỉnh thông tin của nhân viên</p>
                                        <div class="zf-clearBoth"></div>
                                    </li>
                                </ul>

                                <!-- Form Container -->
                                <div class="zf-subContWrap zf-leftAlign">
                                    <ul>
                                        <!-- Tên -->
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">Tên <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <input asp-for="Ten" id="Ten" class="form-control" placeholder="Họ và Tên" required />
                                                <span asp-validation-for="Ten" class="text-danger"></span>
                                            </div>
                                        </li>

                                        <!-- Email -->
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">Email <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <input asp-for="Email" id="Email" class="form-control" placeholder="example@gmail.com" required />
                                                <span asp-validation-for="Email" class="text-danger"></span>
                                            </div>
                                        </li>

                                        <!-- Số điện thoại -->
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">SĐT <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <input asp-for="Sdt" id="Sdt" class="form-control" placeholder="(+84) 123 456 789" required />
                                                <span asp-validation-for="Sdt" class="text-danger"></span>
                                            </div>
                                        </li>

                                        <!-- Chức vụ -->
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">Chức vụ <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <select asp-for="MaCv" id="MaCv" class="form-control" asp-items="ViewBag.ChucVuList" required>
                                                    <option value="" selected>- Chọn chức vụ -</option>
                                                </select>
                                                <span asp-validation-for="MaCv" class="text-danger"></span>
                                            </div>
                                        </li>

                                        <!-- Kinh nghiệm -->
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">Kinh nghiệm <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <input asp-for="KinhNghiem" id="KinhNghiem" class="form-control" placeholder="Năm kinh nghiệm" required />
                                                <span asp-validation-for="KinhNghiem" class="text-danger"></span>
                                            </div>
                                        </li>

                                        <!-- Địa chỉ -->
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">Địa chỉ <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <input asp-for="Diachi" id="Diachi" class="form-control" placeholder="Địa chỉ" required />
                                                <span asp-validation-for="Diachi" class="text-danger"></span>
                                            </div>
                                        </li>

                                        <!-- Giới tính -->
                                        <li class="zf-radio zf-tempFrmWrapper">
                                            <label class="zf-labelName">Giới tính <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <div>
                                                    <input type="radio" name="Gioi" value="true" id="GioiFemale" required />
                                                    <label for="GioiFemale">Nữ</label>
                                                </div>
                                                <div>
                                                    <input type="radio" name="Gioi" value="false" id="GioiMale" required />
                                                    <label for="GioiMale">Nam</label>
                                                </div>
                                                <span asp-validation-for="Gioi" class="text-danger"></span>
                                            </div>
                                        </li>

                                        <!-- Ảnh đại diện -->
                                        <li class="zf-tempFrmWrapper">
                                            <label class="zf-labelName">Ảnh đại diện</label>
                                            <div class="zf-tempContDiv">
                                                <input type="file" name="hinh" id="hinh" class="form-control" />
                                            </div>
                                        </li>

                                        <!-- Mật khẩu -->
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">Mật khẩu <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <input asp-for="MatKhau" id="MatKhau" type="password" class="form-control" placeholder="Mật khẩu" required />
                                                <span asp-validation-for="MatKhau" class="text-danger"></span>
                                            </div>
                                        </li>

                                        <!-- Vai trò -->
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">Vai trò <em class="zf-important">*</em></label>
                                            <div class="zf-tempContDiv">
                                                <select asp-for="Role" id="Role" class="form-control" asp-items="ViewBag.Roles" required>
                                                    <option value="" selected>- Chọn vai trò -</option>
                                                </select>
                                                <span asp-validation-for="Role" class="text-danger"></span>
                                            </div>
                                        </li>
                                        <li class="zf-tempFrmWrapper zf-large">
                                            <label class="zf-labelName">Mô tả</label>
                                            <div class="zf-tempContDiv">
                                                <textarea asp-for="Mota" id="Mota" class="form-control" rows="4" placeholder="Nhập mô tả cho nhân viên bạn"></textarea>
                                                <span asp-validation-for="Mota" class="text-danger"></span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Submit Section -->
                                <ul>
                                    <li class="zf-fmFooter">
                                        <button type="submit" class="btn btn-primary zf-submitColor">Tạo mới</button>
                                    </li>
                                </ul>
                            </div>
                        </form>
                    </div>
                </body>

                </html>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>

        document.getElementById('createNhanVienForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData();

            formData.append('MaNv', document.getElementById('MaNv').value);
            formData.append('Ten', document.getElementById('Ten').value);
            formData.append('Sdt', document.getElementById('Sdt').value);
            formData.append('MaCv', document.getElementById('MaCv').value);
            formData.append('KinhNghiem', document.getElementById('KinhNghiem').value);
            formData.append('Diachi', document.getElementById('Diachi').value);
            formData.append('Gioi', document.querySelector('input[name="Gioi"]:checked').value === 'true');
            formData.append('Email', document.getElementById('Email').value);
            formData.append('MatKhau', document.getElementById('MatKhau').value);
            formData.append('Role', document.getElementById('Role').value);
            formData.append('Mota', document.getElementById('Mota').value);

            const avatar = document.querySelector('input[name="hinh"]').files[0];
            if (avatar) {
                formData.append('hinh', avatar);
            }
            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }
            const maNv = formData.get('MaNv');
            console.log("Updating NhanVien with MaNv:", maNv); 

            try {
                const response = await fetch(`/Admin/NhanViens/api/NhanViens/Update/${maNv}`, {
                    method: 'PUT',
                    body: formData
                });


                console.log('Response Status:', response.status);
                const responseText = await response.text();

                if (response.ok) {
                    alert("Cập nhật nhân viên thành công!");
                    window.location.href = '@Url.Action("Index", "NhanViens")'; 
                } else {
                    let errorMessage = "Đã xảy ra lỗi không xác định.";
                    try {
                        const error = JSON.parse(responseText);
                        errorMessage = error.message;
                    } catch {
                        errorMessage = responseText;
                    }
                    alert("Lỗi khi cập nhật nhân viên: " + errorMessage);
                }
            } catch (error) {
                alert("Đã xảy ra lỗi: " + error.message);
            }
        });
        document.querySelector('input[name="hinh"]').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('previewImage');
                    img.src = e.target.result; // Set the source of the preview image
                };
                reader.readAsDataURL(file); // Read the file as a data URL
            }
        });
    </script>
}